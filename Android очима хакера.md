1. [[Android очима хакера. Евгений Зобнин#Частина перша|Частина перша]]
	1. [[Android очима хакера. Евгений Зобнин#Глава 1. П'ять стовпів Android. Технології, що лежать в основі самої популярної ОС|Глава 1. П'ять стовпів Android. Технології, що лежать в основі]]
		1. [[Android очима хакера. Евгений Зобнин#Віртуальна машина|Віртуальна машина]]
		2. [[Android очима хакера. Евгений Зобнин#Багатозадачність|Багатозадачність]]
		3. [[Android очима хакера. Евгений Зобнин#Binder|Binder]]
		4. [[Android очима хакера. Евгений Зобнин#Сервіси Google|Сервіси Google]]
		5. [[Android очима хакера. Евгений Зобнин#Android Go|Android Go]]
	2. [[Android очима хакера. Евгений Зобнин#Глава 2. Від кнопки включення до робочого стола|Від кнопки включення до робочого стола]]
		1. [[Android очима хакера. Евгений Зобнин#Крок перший. Aboot і таблиця розділів|Крок перший. Aboot і таблиця розділів]]
		2. [[Android очима хакера. Евгений Зобнин#Крок другий. Розділ `boot`|Крок другий. Розділ boot]]
		3. [[Android очима хакера. Евгений Зобнин#Крок другий, альтернативний. Розділ `recovery`|Крок другий, альтернативний. Розділ recovery]]
2. [[Android очима хакера. Евгений Зобнин#Частина друга|Частина друга]]
	1. 

# Частина перша
## Глава 1. П'ять стовпів Android. Технології, що лежать в основі самої популярної ОС
### Віртуальна машина
В основі Android лежить віртуальна машина Java. На відміну від IOS, де код зразу перетворюється на машинні інструкції; віртуальна машина Java спочатку конвертує код в проміжковий байт-код, який у пізніше перетворююється в машинний код. В залежності від методів перетворення байт-коду в машинний, Android жертвує швидкістю чи місцем в оперативній пам'яті.
### Багатозадачність
В Android з самого початку були проблеми зі зловживанням роботою додатків в фоні. Для боротьби з цим явищем, Google почала ділити додатки на 5 груп:
1. Active: Використовується в даний момент або використовувалося зовсім недавно
2. Working set: Часто використовувані додатки
3. Frequent: Регулярно використовувані додатки (необов'язково щодня)
4. Rare: Рідко використовувані додатки
5. Never: Встановлені, але ні разу не запущені
==Чим рідше використовується додаток, тим більш він урізаний в роботі фоном. Додатки також працюють без обмежень, якщо він добавлений у виключення, або телефон знаходиться на зарядці. Починаючи з Android 12, додатки, що не використовуються протягом тижднів втрачають надані користувачем превілегії.==
### Binder
==Кожен додаток в Android працює у власній "пісочниці", яка запускається від імені окремого користувача Linux.== Це дозволяє обмежити круг видимості власною директорією: `data/data`. Для зв'язку з іншими додатками або ОС використовуються механізм Binder. Для прикладу: щоб звернутися до сервісу буфера обміну використовується Intent, який формує відсилає повідомлення через Binder. Повідомлення перехоплює Service Manager, який перевіряє права додатка за допомогою індентифікатору користувача, який запустив процес (UID).
![[android-binder.png]]
### Сервіси Google
Відкритий код Android не включає у себе сервіси Google, які відповідаються за велику кількість функцій без яких дуже проблематично користуватися пристроєм. Як альтернатива, існує проект [MicroG](https://github.com/microg), який має на меті впровадженя основних функцій.
### Ядро Linux і рантайм
Android заснований на ядрі Linux, яке керує доступом до заліза, оперативної та постійної пам'яті, запуском, зупинкою і переносом процесів між ядрами тощо. ==Більшість консольних додатків написаних для Linux, можна портувати для Android простою перекомпіляцією за допомогою кросс-компілятора.==
![[android-architecture.png]]
### Android Go
Android Go - це ще більш урізана версія Android призначена в першу чергу для пристроїв з оперативною пам'яттю 1 Гб або менше.

## Глава 2. Від кнопки включення до робочого стола
### Крок перший. Aboot і таблиця розділів
Після подання живлення система виконує код записаний в boot ROM, який запускає загружчик. Роль загружчика в Android зазвичай відіграє aboot з підтримкою протокола fastboot, однак викорибник може вибрати любий інший. ==Протокол fastboot представляє собою систему для управління загружчиком з ПК.==

==Получивши управління, aboot перевіряє таблицю розділів та загружає систему з розділу `boot` чи `recovery` в залежності від розділу `misc`.== Зазвичай пам'ять на Android пристроях ділиться на вісім розділів:
1. `boot` - містить ядро Linux і RAM-диск, на пристроях з A/B розміткою також містить консоль відновлення (recovery).
2. `recovery` - консоль відновлення. Складається з ядра, набору консольних програм і файла налаштувань. Відсутній на пристроях з A/B-розміткою.
3. `misc` - вказує загружчику з якого розділу загружати систему: `boot` чи `recovery`. Відсутній на пристроях з A/B-розміткою.
4. `system` - містить саму ОС Android, системні бібліотеки, системні додатки, стандартні рингтони, шпалери тощо.
5. `cache` - розділ призначений для зберігання кешованих даних, наприклад файлу оновлення. Відсутній на пристроях з A/B-розміткою.
6. `vendor` - містить драйвера і всі необхідні компоненти для роботи з "залізом".
7. `userdata` - містить налаштування, додатки і дані користувача.
8. `vbmeta` - спеціальний розділ для Android Verified Boot 2.0. Містить контрольні суми компонентів системи.
![[android-booting.png]]

### Крок другий. Розділ `boot`
У випадку відсутності "прапора загрузки в recovery" загружчик передає управління коду в розділі `boot`. На початку розділу розміщене ядро Linux, а за ним йде образ RAM-диска (віртуального жорсткого диску, який існує тільки в операційній системі). 

На RAM-диску розміщується "скелет" операційної системи: необхідні для стартової загрузки файли та каталоги. Ядро підключає RAM-диск в якості кореня системи, а уже до нього підключаються інші розділи. Класичне наповнення RAM-диска виглядає так:
- `data` - каталог для монтування розділу `data`
- `dev` - файли пристроїв
- `proc` - сюди монтується `procfs`
- `res` - набір зображень для changer
- `bin` і `sbin` - набір підсобних утиліт і демонів
- `sys` - сюди монтується `sysfs`
- `system` - каталог для монтування системного розділу
- `build.prop` - системні налаштування
- `init` - система ініціалізації
- `init.rc` - налаштування системи ініціалізації
- `ueventd.rc` - налаштування демона uеventd, що входить до складу `init`
==Центральним є виконуваний файл `init` і його конфіг `init.rc`. На пристроях, що використовуюють A/B-розмітку або режим `system-as-root`, всі ці каталоги і файли знаходяться в системного розділі, а на RAM-диску зберігається консоль відновлення.== 

Файл `ueventd.rc` представляє собою конфіг, який визначає, які файли пристроїв в каталозі `sys` повинні бути створені на етапі загрузки системи. ==В Linux доступ до "заліза" відбувається через спеціальні файли в середині каталога `dev`. За їх створення відповідає ueventd демон, який є частиною `init`.== В `ueventd.rc` перечислені файли, які мають бути створені самостійно, а не ядром.

 Каталог `proc` є типовим для Linux, в наступних етапах загрузки `init` підключить `procfs` до нього, віртуальну файлову систему, яка надає доступ до інформації про всі процеси системи. До каталогу `sys` система підключить `sysfs`, відкриває доступ до інформації про "залізо" і до його налаштувань. За допомогою `sysfs` можна, наприклад, відправити пристрій в сон.

### Крок другий, альтернативний. Розділ `recovery`
У випадку, якщо "прапор загрузки recovery" в розділі `misc` установлений або користувач включив смартфон спеціальною комбінацією клавіш, загружчик передає управління коду, що відповідає за запуск консолі відновлення. У випадку пристрію, який використовує A/B-розмітку загружчик, як і в звичайному варіанті, загружає ядро з розділу `boot`, але замість розділу `system` в якості кореня підключає RAM-диск. Якщо ж пристрій використовує класичну розмітку, управління перадається ядру Linux, записаному в розділ `recovery`, яке також загружає RAM-диск, але зі свого розділу.

# Частина друга
## Глава 6. Основи взлома
### Робимо платне безплатним
#### Cпоряджаємося
